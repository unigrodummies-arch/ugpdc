<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uni Gro - Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <h4 class="fw-bold text-primary">Financial Reports</h4>
            <a href="/" class="btn btn-sm btn-outline-secondary">üè† Home</a>
        </div>

        <ul class="nav nav-pills mb-4 no-print" id="pills-tab" role="tablist">
    <li class="nav-item">
        <button id="btn-outstanding" class="nav-link active" onclick="loadOutstanding()">Outstanding Report</button>
    </li>
    <li class="nav-item ms-2">
        <button id="btn-payments" class="nav-link" onclick="loadPayments()">Payments Report</button>
    </li>
</ul>

        <div class="mb-3 no-print">
    <button class="btn btn-sm btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
    <button class="btn btn-sm btn-danger" onclick="downloadPDF()">üìÑ Download PDF</button>
    <button class="btn btn-sm btn-dark" onclick="window.print()">üñ®Ô∏è Print Report</button>
</div>

        <div class="card border-0 shadow-sm p-3">
            <h5 id="report_title" class="text-center mb-3 fw-bold">Customer-wise Outstanding</h5>
            <div class="table-responsive">
                <table class="table table-bordered align-middle small" id="report_table">
                    <thead id="table_head" class="table-dark text-center"></thead>
                    <tbody id="table_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let currentReport = 'outstanding';

    // Helper to change active tab highlight
    function setActiveTab(reportType) {
        document.getElementById('btn-outstanding').classList.remove('active');
        document.getElementById('btn-payments').classList.remove('active');
        
        if(reportType === 'outstanding') {
            document.getElementById('btn-outstanding').classList.add('active');
        } else {
            document.getElementById('btn-payments').classList.add('active');
        }
    }

    function loadOutstanding() {
        currentReport = 'outstanding';
        setActiveTab('outstanding');
        document.getElementById('report_title').innerText = "Customer-wise Outstanding Report";
        
        fetch('/get_outstanding_report')
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                // Explicitly define columns to prevent "messed up" headers
                const columns = [
                    { label: 'Customer', key: 'customer' },
                    { label: 'Cheque No', key: 'cheque_no' },
                    { label: 'Chq Date', key: 'chq_date' },
                    { label: 'Total Amt', key: 'total_amount' },
                    { label: 'Paid', key: 'paid' },
                    { label: 'Balance', key: 'balance' }
                ];
                renderTable(columns, data.data);
            }
        });
    }

    function loadPayments() {
        currentReport = 'payments';
        setActiveTab('payments');
        document.getElementById('report_title').innerText = "Customer-wise Payments Report";
        
        fetch('/get_payments_report')
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const columns = [
                    { label: 'Customer', key: 'customer' },
                    { label: 'Cheque No', key: 'cheque_no' },
                    { label: 'Amount Paid', key: 'amount_paid' },
                    { label: 'Status', key: 'status' },
                    { label: 'Date', key: 'date' }
                ];
                renderTable(columns, data.data);
            }
        });
    }

    function renderTable(columns, rows) {
        // Render Headers
        let headHtml = '<tr>';
        columns.forEach(col => headHtml += `<th>${col.label}</th>`);
        document.getElementById('table_head').innerHTML = headHtml + '</tr>';

        // Render Body using the 'key' to ensure data matches header
        let bodyHtml = '';
        rows.forEach(row => {
            bodyHtml += '<tr class="text-center">';
            columns.forEach(col => {
                let val = row[col.key];
                // Format numbers if they are numeric and not the Cheque No
                if (typeof val === 'number' && col.key !== 'cheque_no') {
                    val = val.toLocaleString(undefined, {minimumFractionDigits: 2});
                }
                bodyHtml += `<td>${val || ''}</td>`;
            });
            bodyHtml += '</tr>';
        });
        document.getElementById('table_body').innerHTML = bodyHtml;
    }

    function exportToExcel() {
        let table = document.getElementById("report_table");
        let wb = XLSX.utils.table_to_book(table, {sheet: "Report"});
        XLSX.writeFile(wb, `${currentReport}_report.xlsx`);
    }

    function downloadPDF() {
    // Select the element containing the report title and table
    const element = document.querySelector(".card");
    
    // Configure the PDF settings
    const opt = {
        margin:       0.5,
        filename:     `${currentReport}_report.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    // New Promise-based usage to generate and save the PDF
    html2pdf().set(opt).from(element).save();
}

    window.onload = loadOutstanding;
</script>
</body>
</html>